{% extends 'base.html' %}

{% block title %}{{ texts.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>
                    {{ texts.subtitle }}
                </h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.temperatura.id_for_label }}" class="form-label">
                                <i class="fas fa-thermometer-half me-1"></i>
                                {{ texts.temperature }}
                            </label>
                            {{ form.temperatura }}
                            {% if form.temperatura.help_text %}
                                <div class="form-text">{{ form.temperatura.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.humedad.id_for_label }}" class="form-label">
                                <i class="fas fa-tint me-1"></i>
                                {{ texts.humidity }}
                            </label>
                            {{ form.humedad }}
                            {% if form.humedad.help_text %}
                                <div class="form-text">{{ form.humedad.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.presion.id_for_label }}" class="form-label">
                                <i class="fas fa-compress-arrows-alt me-1"></i>
                                {{ texts.pressure }}
                            </label>
                            {{ form.presion }}
                            {% if form.presion.help_text %}
                                <div class="form-text">{{ form.presion.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.velocidad_viento.id_for_label }}" class="form-label">
                                <i class="fas fa-wind me-1"></i>
                                {{ texts.wind_speed }}
                            </label>
                            {{ form.velocidad_viento }}
                            {% if form.velocidad_viento.help_text %}
                                <div class="form-text">{{ form.velocidad_viento.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.altura.id_for_label }}" class="form-label">
                                <i class="fas fa-mountain me-1"></i>
                                {{ form.altura.label }}
                            </label>
                            {{ form.altura }}
                            {% if form.altura.help_text %}
                                <div class="form-text">{{ form.altura.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.nubosidad.id_for_label }}" class="form-label">
                                <i class="fas fa-cloud me-1"></i>
                                {{ form.nubosidad.label }}
                            </label>
                            {{ form.nubosidad }}
                            {% if form.nubosidad.help_text %}
                                <div class="form-text">{{ form.nubosidad.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Mapa de Google Maps -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-map me-2"></i>
                                        Seleccionar Ubicación
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="{{ form.ubicacion.id_for_label }}" class="form-label">
                                            <i class="fas fa-search me-1"></i>
                                            {{ form.ubicacion.label }}
                                        </label>
                                        {{ form.ubicacion }}
                                        {% if form.ubicacion.help_text %}
                                            <div class="form-text">{{ form.ubicacion.help_text }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Mapa de Google Maps -->
                                    <div id="map" style="height: 400px; width: 100%; border-radius: 10px;"></div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="{{ form.latitud.id_for_label }}" class="form-label">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ form.latitud.label }}
                                            </label>
                                            {{ form.latitud }}
                                            {% if form.latitud.help_text %}
                                                <div class="form-text">{{ form.latitud.help_text }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="{{ form.longitud.id_for_label }}" class="form-label">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ form.longitud.label }}
                                            </label>
                                            {{ form.longitud }}
                                            {% if form.longitud.help_text %}
                                                <div class="form-text">{{ form.longitud.help_text }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Instrucciones:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Busca una ubicación en el campo de búsqueda</li>
                                            <li>Haz clic en el mapa para seleccionar la ubicación exacta</li>
                                            <li>Los campos de latitud, longitud y altura se llenarán automáticamente</li>
                                            <li>Puedes editar las coordenadas manualmente si es necesario</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-calculator me-2"></i>
                            {{ texts.calculate_forecast }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    {{ texts.recent_records }}
                </h5>
            </div>
            <div class="card-body">
                {% if ultimos_registros %}
                    {% for registro in ultimos_registros %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                            <div>
                                <strong>{{ registro.temperatura }}°C</strong>
                                <br>
                                <small class="text-muted">{{ registro.fecha|date:"d/m/Y H:i" }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ registro.humedad }}%</span>
                                <br>
                                <small class="text-muted">{{ registro.velocidad_viento }} km/h</small>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'historial' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list me-1"></i>
                            Ver Todo el Historial
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-cloud-rain fa-3x mb-3"></i>
                        <p>No hay registros aún</p>
                        <p class="small">Ingresa los primeros datos del clima para comenzar</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Información
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <i class="fas fa-thermometer-half text-danger me-2"></i>
                    <strong>Temperatura:</strong> Grados Celsius
                </p>
                <p class="mb-2">
                    <i class="fas fa-tint text-info me-2"></i>
                    <strong>Humedad:</strong> Porcentaje relativo
                </p>
                <p class="mb-2">
                    <i class="fas fa-compress-arrows-alt text-warning me-2"></i>
                    <strong>Presión:</strong> Hectopascales (hPa)
                </p>
                <p class="mb-0">
                    <i class="fas fa-wind text-primary me-2"></i>
                    <strong>Viento:</strong> Kilómetros por hora
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Google Maps API -->
<script>
    // Inicializar el mapa cuando la página esté cargada
    let map;
    let marker;
    let geocoder;
    let searchBox;

    function initMap() {
        // Coordenadas por defecto (Madrid, España)
        const defaultLocation = { lat: 40.4168, lng: -3.7038 };
        
        // Crear el mapa
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 10,
            center: defaultLocation,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        });

        // Crear el geocoder
        geocoder = new google.maps.Geocoder();
        
        // Crear el marcador
        marker = new google.maps.Marker({
            position: defaultLocation,
            map: map,
            draggable: true,
            title: "Ubicación seleccionada"
        });

        // Crear el campo de búsqueda
        const input = document.getElementById("ubicacion-input");
        searchBox = new google.maps.places.SearchBox(input);
        
        // Configurar el mapa para usar el campo de búsqueda
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        // Evento cuando se selecciona un lugar de la búsqueda
        searchBox.addListener("places_changed", () => {
            const places = searchBox.getPlaces();
            
            if (places.length === 0) return;
            
            // Limpiar marcadores anteriores
            marker.setMap(null);
            
            // Obtener límites para ajustar el mapa
            const bounds = new google.maps.LatLngBounds();
            
            places.forEach((place) => {
                if (!place.geometry || !place.geometry.location) {
                    console.log("Returned place contains no geometry");
                    return;
                }
                
                // Crear nuevo marcador
                marker = new google.maps.Marker({
                    map: map,
                    title: place.name,
                    position: place.geometry.location,
                    draggable: true
                });
                
                // Actualizar campos de latitud y longitud
                updateCoordinates(place.geometry.location.lat(), place.geometry.location.lng());
                
                if (place.geometry.viewport) {
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
            });
            
            map.fitBounds(bounds);
        });

        // Evento cuando se hace clic en el mapa
        map.addListener("click", (event) => {
            const lat = event.latLng.lat();
            const lng = event.latLng.lng();
            
            // Mover el marcador a la nueva posición
            marker.setPosition(event.latLng);
            
            // Actualizar campos de latitud, longitud y altura
            updateCoordinates(lat, lng);
            
            // Obtener dirección y altura
            getAddressAndElevation(event.latLng);
        });

        // Evento cuando se arrastra el marcador
        marker.addListener("dragend", (event) => {
            const lat = event.latLng.lat();
            const lng = event.latLng.lng();
            
            // Actualizar campos de latitud, longitud y altura
            updateCoordinates(lat, lng);
            
            // Obtener dirección y altura
            getAddressAndElevation(event.latLng);
        });

        // Función para actualizar los campos de coordenadas
        function updateCoordinates(lat, lng) {
            document.getElementById("latitud-input").value = lat.toFixed(6);
            document.getElementById("longitud-input").value = lng.toFixed(6);
        }

        // Función para obtener dirección y altura
        function getAddressAndElevation(latLng) {
            // Obtener dirección usando geocoder
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    document.getElementById("ubicacion-input").value = results[0].formatted_address;
                }
            });
            
            // Obtener altura usando Open-Elevation API
            const lat = latLng.lat();
            const lng = latLng.lng();
            getElevationFromCoordinates(lat, lng);
        }

        // Función para obtener altura
        function getElevationFromCoordinates(lat, lng) {
            const elevationUrl = `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`;
            
            fetch(elevationUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const elevation = data.results[0].elevation;
                        document.getElementById("altura-input").value = Math.round(elevation);
                    }
                })
                .catch(error => {
                    console.error('Error obteniendo altura:', error);
                    document.getElementById("altura-input").value = 0;
                });
        }

        // Eventos para actualizar el mapa cuando se editan las coordenadas manualmente
        document.getElementById('latitud-input').addEventListener('input', updateMapFromCoordinates);
        document.getElementById('longitud-input').addEventListener('input', updateMapFromCoordinates);

        // Función para actualizar el mapa desde coordenadas manuales
        function updateMapFromCoordinates() {
            const lat = parseFloat(document.getElementById('latitud-input').value);
            const lng = parseFloat(document.getElementById('longitud-input').value);
            
            if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                const newLatLng = new google.maps.LatLng(lat, lng);
                
                // Actualizar mapa y marcador
                map.setCenter(newLatLng);
                marker.setPosition(newLatLng);
                
                // Obtener dirección y altura
                getAddressAndElevation(newLatLng);
            }
        }

        // Establecer coordenadas iniciales
        updateCoordinates(defaultLocation.lat, defaultLocation.lng);
        getAddressAndElevation(new google.maps.LatLng(defaultLocation.lat, defaultLocation.lng));
    }

    // Cargar el mapa cuando la página esté lista
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si Google Maps está cargado
        if (typeof google !== 'undefined' && google.maps) {
            initMap();
        } else {
            console.error('Google Maps API no está cargada');
        }
    });
</script>

<!-- Cargar Google Maps API -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_AQUI&libraries=places&callback=initMap">
</script>

<!-- Nota: Reemplaza TU_API_KEY_AQUI con tu clave de API de Google Maps -->
<script>
    // Mostrar mensaje si no hay API key
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.warn('⚠️ IMPORTANTE: Para usar Google Maps, necesitas obtener una API key gratuita:');
        console.log('1. Ve a: https://console.cloud.google.com/');
        console.log('2. Crea un proyecto o selecciona uno existente');
        console.log('3. Habilita la API de Maps JavaScript y Places API');
        console.log('4. Crea credenciales (API Key)');
        console.log('5. Reemplaza "TU_API_KEY_AQUI" en el script con tu clave real');
    }
</script>
{% endblock %}
