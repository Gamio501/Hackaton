{% extends 'base.html' %}

{% block title %}{{ texts.title }}{% endblock %}

{% block content %}
<!-- Selector de idioma directo en la p√°gina -->
<div class="row mb-3">
    <div class="col-12 text-end">
        <div class="btn-group" role="group">
            <a href="?lang=es" class="btn btn-sm {% if language == 'es' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                üá™üá∏ Espa√±ol
            </a>
            <a href="?lang=en" class="btn btn-sm {% if language == 'en' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                üá∫üá∏ English
            </a>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>
                    {{ texts.enter_climate_data }}
                </h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.temperatura.id_for_label }}" class="form-label">
                                <i class="fas fa-thermometer-half me-1"></i>
                                {{ texts.temperature }}
                            </label>
                            {{ form.temperatura }}
                            {% if form.temperatura.help_text %}
                                <div class="form-text">{{ form.temperatura.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.humedad.id_for_label }}" class="form-label">
                                <i class="fas fa-tint me-1"></i>
                                {{ texts.humidity }}
                            </label>
                            {{ form.humedad }}
                            {% if form.humedad.help_text %}
                                <div class="form-text">{{ form.humedad.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.presion.id_for_label }}" class="form-label">
                                <i class="fas fa-compress-arrows-alt me-1"></i>
                                {{ texts.pressure }}
                            </label>
                            {{ form.presion }}
                            {% if form.presion.help_text %}
                                <div class="form-text">{{ form.presion.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.velocidad_viento.id_for_label }}" class="form-label">
                                <i class="fas fa-wind me-1"></i>
                                {{ texts.wind_speed }}
                            </label>
                            {{ form.velocidad_viento }}
                            {% if form.velocidad_viento.help_text %}
                                <div class="form-text">{{ form.velocidad_viento.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.altura.id_for_label }}" class="form-label">
                                <i class="fas fa-mountain me-1"></i>
                                {{ texts.altitude }}
                            </label>
                            {{ form.altura }}
                            {% if form.altura.help_text %}
                                <div class="form-text">{{ form.altura.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.nubosidad.id_for_label }}" class="form-label">
                                <i class="fas fa-cloud me-1"></i>
                                {{ texts.cloudiness }}
                            </label>
                            {{ form.nubosidad }}
                            {% if form.nubosidad.help_text %}
                                <div class="form-text">{{ form.nubosidad.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Mapa de OpenStreetMap -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-map me-2"></i>
                                        {{ texts.select_location }} (OpenStreetMap)
                                    </h5>
                                    <small class="text-light">
                                        <i class="fas fa-mouse-pointer"></i> 
                                        <strong>{{ texts.new_feature }}</strong> {{ texts.click_map_instruction }}
                                    </small>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="{{ form.ubicacion.id_for_label }}" class="form-label">
                                            <i class="fas fa-search me-1"></i>
                                            {{ texts.search_location }}
                                        </label>
                                        {{ form.ubicacion }}
                                        {% if form.ubicacion.help_text %}
                                            <div class="form-text">{{ form.ubicacion.help_text }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="{{ form.nombre_lugar.id_for_label }}" class="form-label">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ texts.place_name }}
                                        </label>
                                        {{ form.nombre_lugar }}
                                        {% if form.nombre_lugar.help_text %}
                                            <div class="form-text">{{ form.nombre_lugar.help_text }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Mapa de OpenStreetMap -->
                                    <div id="map" style="height: 400px; width: 100%; border-radius: 10px;"></div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="{{ form.latitud.id_for_label }}" class="form-label">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ texts.latitude }}
                                            </label>
                                            {{ form.latitud }}
                                            {% if form.latitud.help_text %}
                                                <div class="form-text">{{ form.latitud.help_text }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="{{ form.longitud.id_for_label }}" class="form-label">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ texts.longitude }}
                                            </label>
                                            {{ form.longitud }}
                                            {% if form.longitud.help_text %}
                                                <div class="form-text">{{ form.longitud.help_text }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Secci√≥n de Par√°metros de Aerosoles y Polvo Atmosf√©rico -->
                                    <div class="mt-4">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-wind me-2"></i>
                                            Par√°metros de Aerosoles y Polvo Atmosf√©rico
                                        </h6>
                                        
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.densidad_polvo.id_for_label }}" class="form-label">
                                                        <i class="fas fa-dust me-1"></i>
                                                        {{ texts.dust_density }}
                                                    </label>
                                                    {{ form.densidad_polvo }}
                                                    {% if form.densidad_polvo.help_text %}
                                                        <div class="form-text">{{ form.densidad_polvo.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.pm25.id_for_label }}" class="form-label">
                                                        <i class="fas fa-circle me-1"></i>
                                                        {{ form.pm25.label }}
                                                    </label>
                                                    {{ form.pm25 }}
                                                    {% if form.pm25.help_text %}
                                                        <div class="form-text">{{ form.pm25.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.pm10.id_for_label }}" class="form-label">
                                                        <i class="fas fa-circle me-1"></i>
                                                        {{ form.pm10.label }}
                                                    </label>
                                                    {{ form.pm10 }}
                                                    {% if form.pm10.help_text %}
                                                        <div class="form-text">{{ form.pm10.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.diametro_medio.id_for_label }}" class="form-label">
                                                        <i class="fas fa-ruler me-1"></i>
                                                        {{ texts.mean_diameter }}
                                                    </label>
                                                    {{ form.diametro_medio }}
                                                    {% if form.diametro_medio.help_text %}
                                                        <div class="form-text">{{ form.diametro_medio.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.desviacion_diametro.id_for_label }}" class="form-label">
                                                        <i class="fas fa-chart-line me-1"></i>
                                                        {{ texts.diameter_deviation }}
                                                    </label>
                                                    {{ form.desviacion_diametro }}
                                                    {% if form.desviacion_diametro.help_text %}
                                                        <div class="form-text">{{ form.desviacion_diametro.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="{{ form.aod.id_for_label }}" class="form-label">
                                                        <i class="fas fa-eye me-1"></i>
                                                        {{ texts.aod }}
                                                    </label>
                                                    {{ form.aod }}
                                                    {% if form.aod.help_text %}
                                                        <div class="form-text">{{ form.aod.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.visibilidad.id_for_label }}" class="form-label">
                                                        <i class="fas fa-eye me-1"></i>
                                                        {{ texts.visibility }}
                                                    </label>
                                                    {{ form.visibilidad }}
                                                    {% if form.visibilidad.help_text %}
                                                        <div class="form-text">{{ form.visibilidad.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="{{ form.altura_capa_mezcla.id_for_label }}" class="form-label">
                                                        <i class="fas fa-layer-group me-1"></i>
                                                        {{ texts.mixing_layer_height }}
                                                    </label>
                                                    {{ form.altura_capa_mezcla }}
                                                    {% if form.altura_capa_mezcla.help_text %}
                                                        <div class="form-text">{{ form.altura_capa_mezcla.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            <strong>{{ texts.note }}:</strong> {{ texts.aerosol_note }}
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-success mt-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>{{ texts.instructions }}</strong>
                                        <ul class="mb-0 mt-2">
                                            <li><strong>{{ texts.autocomplete }}:</strong> {{ texts.autocomplete_desc }}</li>
                                            <li><strong>{{ texts.selection }}:</strong> {{ texts.selection_desc }}</li>
                                            <li><strong>{{ texts.map }}:</strong> {{ texts.map_desc }}</li>
                                            <li><strong>{{ texts.auto_fill }}:</strong> {{ texts.auto_fill_desc }}</li>
                                            <li><strong>{{ texts.manual }}:</strong> {{ texts.manual_desc }}</li>
                                            <li><strong>{{ texts.no_api_key }}</strong> - {{ texts.completely_free }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-warning btn-lg" onclick="calcularAerosoles()">
                            <i class="fas fa-wind me-2"></i>
                            {{ texts.calculate_aerosols }}
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-calculator me-2"></i>
                            {{ texts.calculate_forecast }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    {{ texts.recent_records }}
                </h5>
            </div>
            <div class="card-body">
                {% if ultimos_registros %}
                    {% for registro in ultimos_registros %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                            <div>
                                <strong>{{ registro.temperatura }}{% if language == 'en' %}¬∞F{% else %}¬∞C{% endif %}</strong>
                                <br>
                                <small class="text-muted">{{ registro.fecha|date:"d/m/Y H:i" }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ registro.humedad }}%</span>
                                <br>
                                <small class="text-muted">{{ registro.velocidad_viento }} {% if language == 'en' %}mph{% else %}km/h{% endif %}</small>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'historial' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list me-1"></i>
                            {% if language == 'en' %}View All History{% else %}Ver Todo el Historial{% endif %}
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-cloud-rain fa-3x mb-3"></i>
                        <p>{% if language == 'en' %}No records yet{% else %}No hay registros a√∫n{% endif %}</p>
                        <p class="small">{% if language == 'en' %}Enter the first climate data to get started{% else %}Ingresa los primeros datos del clima para comenzar{% endif %}</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ texts.information }}
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <i class="fas fa-thermometer-half text-danger me-2"></i>
                    <strong>{{ texts.temperature }}:</strong> 
                    {% if language == 'en' %}Celsius Degrees{% else %}Grados Celsius{% endif %}
                </p>
                <p class="mb-2">
                    <i class="fas fa-tint text-info me-2"></i>
                    <strong>{{ texts.humidity }}:</strong> 
                    {% if language == 'en' %}Relative Percentage{% else %}Porcentaje relativo{% endif %}
                </p>
                <p class="mb-2">
                    <i class="fas fa-compress-arrows-alt text-warning me-2"></i>
                    <strong>{{ texts.pressure }}:</strong> 
                    {% if language == 'en' %}Hectopascals (hPa){% else %}Hectopascales (hPa){% endif %}
                </p>
                <p class="mb-0">
                    <i class="fas fa-wind text-primary me-2"></i>
                    <strong>{{ texts.wind_speed }}:</strong> 
                    {% if language == 'en' %}Kilometers per hour{% else %}Kil√≥metros por hora{% endif %}
                </p>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-map-marked-alt me-2"></i>
                    OpenStreetMap
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong>Completamente Gratuito</strong>
                </p>
                <p class="mb-2">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong>Sin API Key</strong>
                </p>
                <p class="mb-2">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong>C√≥digo Abierto</strong>
                </p>
                <p class="mb-0">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong>Sin L√≠mites de Uso</strong>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet.js JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- JavaScript simplificado y funcional -->
<script>
    console.log('üöÄ JavaScript cargando...');
    
    // Traducciones para el JavaScript
    const translations = {
        searching: "{% if language == 'en' %}Searching locations...{% else %}Buscando ubicaciones...{% endif %}",
        noResults: "{% if language == 'en' %}No locations found{% else %}No se encontraron ubicaciones{% endif %}",
        selectedLocation: "{% if language == 'en' %}Selected location{% else %}Ubicaci√≥n seleccionada{% endif %}",
        loadingWeather: "{% if language == 'en' %}Loading weather data...{% else %}Cargando datos meteorol√≥gicos...{% endif %}",
        fieldsAutoFilled: "{% if language == 'en' %}Fields automatically filled{% else %}Campos llenados autom√°ticamente{% endif %}",
        otherFieldsManual: "{% if language == 'en' %}Other fields must be completed manually{% else %}Otros campos deben completarse manualmente{% endif %}",
        aerosolCalculated: "{% if language == 'en' %}All aerosol parameters have been calculated automatically{% else %}Todos los par√°metros de aerosoles han sido calculados autom√°ticamente{% endif %}",
        calculating: "{% if language == 'en' %}Calculating...{% else %}Calculando...{% endif %}"
    };

    let map;
    let marker;
    let searchDropdown = null;

    // Inicializar cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ P√°gina cargada, inicializando...');
        initMap();
        initSearch();
    });

    function initMap() {
        console.log('üó∫Ô∏è Inicializando mapa...');
        
        // Intentar cargar la √∫ltima ubicaci√≥n guardada
        const savedLocation = getLastLocation();
        const defaultLocation = savedLocation || [-12.0464, -77.0428];
        
        console.log('üìç Ubicaci√≥n inicial:', savedLocation ? '√öltima ubicaci√≥n guardada' : 'Lima por defecto');
        
        // Crear el mapa
        map = L.map('map').setView(defaultLocation, 10);
        
        // Agregar capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Crear el marcador
        marker = L.marker(defaultLocation, {
            draggable: true,
            title: translations.selectedLocation
        }).addTo(map);

        // Evento cuando se hace clic en el mapa
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            console.log('üìç Clic en mapa:', lat, lng);
            
            // Mover el marcador a la nueva posici√≥n
            marker.setLatLng([lat, lng]);
            
            // Guardar la nueva ubicaci√≥n
            saveLastLocation(lat, lng);
            
            // Actualizar campos
            updateCoordinates(lat, lng);
            getAddressAndElevationFromCoordinates(lat, lng);
            
            // Obtener datos meteorol√≥gicos y rellenar formulario
            updateWeatherData(lat, lng);
        });

        // Evento cuando se arrastra el marcador
        marker.on('dragend', function(e) {
            const lat = e.target.getLatLng().lat;
            const lng = e.target.getLatLng().lng;
            console.log('üîÑ Marcador movido:', lat, lng);
            
            // Guardar la nueva ubicaci√≥n
            saveLastLocation(lat, lng);
            
            // Actualizar campos
            updateCoordinates(lat, lng);
            getAddressAndElevationFromCoordinates(lat, lng);
            
            // Obtener datos meteorol√≥gicos y rellenar formulario
            updateWeatherData(lat, lng);
        });

        // Establecer coordenadas iniciales
        updateCoordinates(defaultLocation[0], defaultLocation[1]);
        getAddressAndElevationFromCoordinates(defaultLocation[0], defaultLocation[1]);
        
        // Obtener datos meteorol√≥gicos iniciales
        updateWeatherData(defaultLocation[0], defaultLocation[1]);
        
        // Si hay ubicaci√≥n guardada, actualizar tambi√©n el input de ubicaci√≥n
        if (savedLocation) {
            console.log('üîÑ Actualizando input de ubicaci√≥n con √∫ltima selecci√≥n');
            // Intentar obtener la direcci√≥n de la ubicaci√≥n guardada
        getAddressAndElevationFromCoordinates(defaultLocation[0], defaultLocation[1]);
    }

        // Actualizar las unidades de visualizaci√≥n
        updateDisplayUnits();
        
        console.log('‚úÖ Mapa inicializado correctamente');
    }

    function initSearch() {
        console.log('üîç Inicializando b√∫squeda...');
        
        // Esperar a que el DOM est√© listo
        setTimeout(() => {
        const searchInput = document.getElementById('ubicacion-input');
            
            if (!searchInput) {
                console.error('‚ùå No se encontr√≥ el input de b√∫squeda');
                return;
            }
            
            console.log('‚úÖ Input de b√∫squeda encontrado');
            
            // Crear dropdown
            createSearchDropdown();
            
            // Evento de b√∫squeda
        let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    hideDropdown();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchLocation(query);
                }, 500);
            });
            
            console.log('‚úÖ B√∫squeda configurada correctamente');
        }, 1000);
    }
    
    function createSearchDropdown() {
        searchDropdown = document.createElement('div');
        searchDropdown.id = 'search-dropdown';
        searchDropdown.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #ddd;
                    border-top: none;
                    border-radius: 0 0 5px 5px;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                
        const searchContainer = document.getElementById('ubicacion-input').parentNode;
        searchContainer.style.position = 'relative';
        searchContainer.appendChild(searchDropdown);
    }
    
    function searchLocation(query) {
        console.log('üîç Buscando:', query);
        showLoading();
        
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('üìã Resultados:', data);
                if (data && data.length > 0) {
                    showSuggestions(data);
                } else {
                    showNoResults();
                }
            })
            .catch(error => {
                console.error('‚ùå Error:', error);
                showError('Error en la b√∫squeda');
            });
    }
    
    function showLoading() {
        searchDropdown.innerHTML = `
                <div style="padding: 15px; text-align: center; color: #666;">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                ${translations.searching}
                </div>
            `;
        searchDropdown.style.display = 'block';
        }

        function showSuggestions(suggestions) {
        searchDropdown.innerHTML = '';
        
        suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 10px 15px;
                    cursor: pointer;
                    border-bottom: 1px solid #eee;
                `;
                item.innerHTML = `
                <div style="font-weight: bold;">${suggestion.display_name.split(',')[0]}</div>
                <div style="font-size: 12px; color: #666;">${suggestion.display_name}</div>
            `;
            
            item.addEventListener('click', () => {
                selectLocation(suggestion);
                hideDropdown();
            });
            
            item.addEventListener('mouseenter', () => {
                item.style.backgroundColor = '#f5f5f5';
            });
            
            item.addEventListener('mouseleave', () => {
                item.style.backgroundColor = 'white';
            });
            
            searchDropdown.appendChild(item);
        });
        
        searchDropdown.style.display = 'block';
    }
    
    function showNoResults() {
        searchDropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #666;">
                <i class="fas fa-search me-2"></i>
                ${translations.noResults}
            </div>
        `;
        searchDropdown.style.display = 'block';
    }
    
    function showError(message) {
        searchDropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #dc3545;">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
        searchDropdown.style.display = 'block';
    }
    
    function hideDropdown() {
        if (searchDropdown) {
            searchDropdown.style.display = 'none';
        }
    }
    
        function selectLocation(suggestion) {
        console.log('üìç Seleccionando:', suggestion.display_name);
            const lat = parseFloat(suggestion.lat);
            const lng = parseFloat(suggestion.lon);
            
        // Guardar la nueva ubicaci√≥n
        saveLastLocation(lat, lng);
        
        // Actualizar inputs
        document.getElementById('ubicacion-input').value = suggestion.display_name;
        document.getElementById('nombre-lugar-input').value = suggestion.display_name;
        
        // Mover mapa
            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);
            
            // Actualizar coordenadas
            updateCoordinates(lat, lng);
        getAddressAndElevationFromCoordinates(lat, lng);
            
        // Obtener datos meteorol√≥gicos y rellenar formulario
            updateWeatherData(lat, lng);
        }

    // Funciones auxiliares
    function updateCoordinates(lat, lng) {
        console.log('üìç Actualizando coordenadas:', lat, lng);
        const latInput = document.getElementById('latitud-input');
        const lngInput = document.getElementById('longitud-input');
        
        if (latInput) latInput.value = lat.toFixed(6);
        if (lngInput) lngInput.value = lng.toFixed(6);
        
        // Actualizar tambi√©n las unidades en la interfaz si es necesario
        updateDisplayUnits();
    }
    
    // Funci√≥n para actualizar las unidades mostradas en la interfaz
    function updateDisplayUnits() {
        const isEnglish = window.location.search.includes('lang=en');
        
        // Actualizar etiquetas de altura si existen
        const altitudeLabels = document.querySelectorAll('label[for*="altura"]');
        altitudeLabels.forEach(label => {
            const text = label.textContent;
            if (text.includes('metros') || text.includes('m)')) {
                label.textContent = text.replace(/metros?/g, isEnglish ? 'feet' : 'metros')
                                      .replace(/\(m\)/g, isEnglish ? '(ft)' : '(m)');
            }
        });
        
        // Actualizar etiquetas de velocidad del viento si existen
        const windLabels = document.querySelectorAll('label[for*="viento"]');
        windLabels.forEach(label => {
            const text = label.textContent;
            if (text.includes('km/h') || text.includes('mph')) {
                label.textContent = text.replace(/km\/h/g, isEnglish ? 'mph' : 'km/h');
            }
        });
        
        // Actualizar etiquetas de temperatura si existen
        const tempLabels = document.querySelectorAll('label[for*="temperatura"]');
        tempLabels.forEach(label => {
            const text = label.textContent;
            if (text.includes('¬∞C') || text.includes('¬∞F')) {
                label.textContent = text.replace(/¬∞C/g, isEnglish ? '¬∞F' : '¬∞C');
            }
        });
        
        // Actualizar etiquetas de presi√≥n si existen
        const pressureLabels = document.querySelectorAll('label[for*="presion"]');
        pressureLabels.forEach(label => {
            const text = label.textContent;
            if (text.includes('hPa') || text.includes('inHg')) {
                label.textContent = text.replace(/hPa/g, isEnglish ? 'inHg' : 'hPa');
            }
        });
        
        // Actualizar etiquetas de visibilidad si existen
        const visibilityLabels = document.querySelectorAll('label[for*="visibilidad"]');
        visibilityLabels.forEach(label => {
            const text = label.textContent;
            if (text.includes('km') || text.includes('mi')) {
                label.textContent = text.replace(/km/g, isEnglish ? 'mi' : 'km');
            }
            });
    }

    function getAddressAndElevationFromCoordinates(lat, lng) {
        // Obtener direcci√≥n
        const addressUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
        
        fetch(addressUrl)
            .then(response => response.json())
            .then(data => {
                if (data.display_name) {
                const ubicacionInput = document.getElementById('ubicacion-input');
                    const nombreLugarInput = document.getElementById('nombre-lugar-input');
                if (ubicacionInput) {
                    ubicacionInput.value = data.display_name;
                }
                    if (nombreLugarInput) {
                        nombreLugarInput.value = data.display_name;
                    }
                }
            })
            .catch(error => {
                console.warn('Error obteniendo direcci√≥n:', error);
            const ubicacionInput = document.getElementById('ubicacion-input');
                const nombreLugarInput = document.getElementById('nombre-lugar-input');
                const coordsText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            if (ubicacionInput) {
                    ubicacionInput.value = coordsText;
                }
                if (nombreLugarInput) {
                    nombreLugarInput.value = coordsText;
            }
            });
        
        // Obtener altura
        getElevationFromCoordinates(lat, lng);
    }

    async function getElevationFromCoordinates(lat, lng) {
        console.log('üèîÔ∏è Obteniendo altura para:', lat, lng);
        
        try {
            const elevation = await getAltitudeFromCoordinates(lat, lng);
                const alturaInput = document.getElementById('altura-input');
                if (alturaInput) {
                const convertedElevation = convertAltitudeToDisplay(elevation);
                alturaInput.value = convertedElevation;
                console.log('‚úÖ Altura actualizada en formulario:', convertedElevation, getAltitudeUnit());
            }
        } catch (error) {
            console.warn('‚ùå Error obteniendo altura:', error);
            const alturaInput = document.getElementById('altura-input');
            if (alturaInput) {
                const fallbackElevation = convertAltitudeToDisplay(100);
                alturaInput.value = fallbackElevation;
            }
        }
    }
    
    // Funci√≥n para obtener datos meteorol√≥gicos y rellenar formulario
    async function updateWeatherData(lat, lng) {
        try {
            console.log('üå§Ô∏è Obteniendo datos meteorol√≥gicos...');
            
            // Mostrar indicador de carga
            showWeatherLoading();
            
            // Obtener datos meteorol√≥gicos reales
            const weatherData = await getRealWeatherData(lat, lng);
            
            if (weatherData) {
                // Rellenar formulario con datos reales
                fillWeatherForm(weatherData);
            } else {
                // Generar datos realistas como fallback
                const fallbackData = await generateRealisticWeatherData(lat, lng);
                fillWeatherForm(fallbackData);
            }
            
        } catch (error) {
            console.error('Error obteniendo datos meteorol√≥gicos:', error);
            
            // Fallback a datos simulados
            const fallbackData = await generateRealisticWeatherData(lat, lng);
            fillWeatherForm(fallbackData);
        }
    }
    
    // Funci√≥n para mostrar indicador de carga
    function showWeatherLoading() {
        // Crear o actualizar indicador de carga
        let loadingDiv = document.getElementById('weather-loading');
        if (!loadingDiv) {
            loadingDiv = document.createElement('div');
            loadingDiv.id = 'weather-loading';
            loadingDiv.className = 'alert alert-info mt-3';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + translations.loadingWeather;
            document.querySelector('.card-body').appendChild(loadingDiv);
        }
    }
    
    // Funci√≥n para obtener datos meteorol√≥gicos reales
    async function getRealWeatherData(lat, lng) {
        try {
            // Usar Open-Meteo API para obtener nubosidad
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=cloudcover`);
            const data = await response.json();
            
            if (data.hourly && data.hourly.cloudcover) {
                return {
                    cloudCover: data.hourly.cloudcover[0] || 0,
                    altitude: await getAltitudeFromCoordinates(lat, lng)
                };
            }
        } catch (error) {
            console.error('Error obteniendo datos meteorol√≥gicos:', error);
        }
        
        return null;
    }
    
    // Funci√≥n para obtener altitud real
    async function getAltitudeFromCoordinates(lat, lng) {
        console.log('üèîÔ∏è Obteniendo altura para:', lat, lng);
        
        // Verificar si es Piura espec√≠ficamente
        if (isPiuraRegion(lat, lng)) {
            console.log('üáµüá™ Detectada regi√≥n de Piura - usando altura correcta');
            const piuraElevation = getPiuraElevation(lat, lng);
            console.log('‚úÖ Altura de Piura:', piuraElevation, 'metros');
            return piuraElevation;
        }
        
        try {
            console.log('üåê Consultando API de elevaci√≥n...');
            const elevationUrl = `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`;
            const response = await fetch(elevationUrl);
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                const elevation = Math.round(data.results[0].elevation);
                console.log('‚úÖ Altura de API:', elevation, 'metros');
                return elevation;
            }
        } catch (error) {
            console.warn('‚ùå Error en API, usando f√≥rmula local:', error);
        }
        
        // Fallback: altura simulada basada en coordenadas geogr√°ficas reales
        let simulatedElevation;
        
        // F√≥rmula mejorada basada en ubicaci√≥n geogr√°fica
        if (lat >= -15 && lat <= 0 && lng >= -85 && lng <= -70) {
            // Regi√≥n costera del Per√∫ (como Piura)
            simulatedElevation = Math.round(20 + Math.random() * 50); // 20-70 metros
        } else if (lat >= -20 && lat <= -5 && lng >= -80 && lng <= -70) {
            // Regi√≥n andina del Per√∫
            simulatedElevation = Math.round(2000 + Math.random() * 2000); // 2000-4000 metros
        } else if (lat >= -15 && lat <= 5 && lng >= -80 && lng <= -60) {
            // Regi√≥n amaz√≥nica
            simulatedElevation = Math.round(100 + Math.random() * 200); // 100-300 metros
        } else {
            // Otras regiones del mundo
            simulatedElevation = Math.round(Math.abs(lat) * 50 + Math.random() * 200);
        }
        
        console.log('üîÑ Usando altura simulada:', simulatedElevation, 'metros');
        return simulatedElevation;
    }
    
    // Funci√≥n para detectar si es la regi√≥n de Piura
    function isPiuraRegion(lat, lng) {
        // Coordenadas aproximadas de Piura y alrededores
        return (lat >= -5.5 && lat <= -4.5 && lng >= -81.5 && lng <= -79.5);
    }
    
    // Funci√≥n para obtener altura espec√≠fica de Piura
    function getPiuraElevation(lat, lng) {
        // Piura est√° a aproximadamente 26 metros sobre el nivel del mar
        // Con una peque√±a variaci√≥n basada en la ubicaci√≥n exacta
        const baseElevation = 26;
        const variation = Math.round((Math.abs(lat + 5.1945) + Math.abs(lng + 80.6328)) * 10);
        return Math.max(20, Math.min(35, baseElevation + variation));
    }
    
    // Funci√≥n para rellenar formulario con datos meteorol√≥gicos
    function fillWeatherForm(data) {
        console.log('üìù Rellenando formulario con:', data);
        
        // Rellenar nubosidad
        const cloudField = document.querySelector('input[name="nubosidad"]');
        if (cloudField) {
            cloudField.value = Math.round(data.cloudCover);
            console.log('‚òÅÔ∏è Nubosidad actualizada:', cloudField.value);
        }
        
        // Rellenar altura (convertir a pies si es ingl√©s)
        const altitudeField = document.querySelector('input[name="altura"]');
        if (altitudeField) {
            const altitude = data.altitude || 0;
            const convertedAltitude = convertAltitudeToDisplay(altitude);
            altitudeField.value = convertedAltitude;
            console.log('üèîÔ∏è Altura actualizada:', convertedAltitude, getAltitudeUnit());
        }
        
        // Ocultar indicador de carga
        const loadingDiv = document.getElementById('weather-loading');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        
        // Mostrar notificaci√≥n de √©xito
        showWeatherSuccess(data);
    }
    
    // Funci√≥n para convertir altura a la unidad de visualizaci√≥n
    function convertAltitudeToDisplay(altitudeInMeters) {
        const isEnglish = window.location.search.includes('lang=en');
        if (isEnglish) {
            // Convertir metros a pies: 1 metro = 3.280839895 pies (precisi√≥n cient√≠fica)
            return Math.round(altitudeInMeters * 3.280839895 * 100) / 100; // 2 decimales
        }
        return Math.round(altitudeInMeters * 100) / 100; // 2 decimales para metros tambi√©n
    }
    
    // Funci√≥n para obtener la unidad de altura
    function getAltitudeUnit() {
        const isEnglish = window.location.search.includes('lang=en');
        return isEnglish ? 'ft' : 'm';
    }
    
    // Funci√≥n para convertir velocidad del viento a la unidad de visualizaci√≥n
    function convertWindSpeedToDisplay(speedInKmh) {
        const isEnglish = window.location.search.includes('lang=en');
        if (isEnglish) {
            // Convertir km/h a mph: 1 km/h = 0.621371192 mph (precisi√≥n cient√≠fica)
            return Math.round(speedInKmh * 0.621371192 * 100) / 100; // 2 decimales
        }
        return Math.round(speedInKmh * 100) / 100; // 2 decimales para km/h tambi√©n
    }
    
    // Funci√≥n para obtener la unidad de velocidad del viento
    function getWindSpeedUnit() {
        const isEnglish = window.location.search.includes('lang=en');
        return isEnglish ? 'mph' : 'km/h';
    }
    
    // Funciones adicionales para investigadores - conversiones precisas
    function convertTemperatureToDisplay(tempInCelsius) {
        const isEnglish = window.location.search.includes('lang=en');
        if (isEnglish) {
            // Convertir Celsius a Fahrenheit: F = (C √ó 9/5) + 32
            return Math.round((tempInCelsius * 9/5 + 32) * 100) / 100; // 2 decimales
        }
        return Math.round(tempInCelsius * 100) / 100; // 2 decimales
    }
    
    function getTemperatureUnit() {
        const isEnglish = window.location.search.includes('lang=en');
        return isEnglish ? '¬∞F' : '¬∞C';
    }
    
    function convertPressureToDisplay(pressureInHpa) {
        const isEnglish = window.location.search.includes('lang=en');
        if (isEnglish) {
            // Convertir hPa a inHg: 1 hPa = 0.029529983071445 inHg
            return Math.round(pressureInHpa * 0.029529983071445 * 1000) / 1000; // 3 decimales
        }
        return Math.round(pressureInHpa * 100) / 100; // 2 decimales
    }
    
    function getPressureUnit() {
        const isEnglish = window.location.search.includes('lang=en');
        return isEnglish ? 'inHg' : 'hPa';
    }
    
    function convertVisibilityToDisplay(visibilityInKm) {
        const isEnglish = window.location.search.includes('lang=en');
        if (isEnglish) {
            // Convertir km a millas: 1 km = 0.621371192 millas
            return Math.round(visibilityInKm * 0.621371192 * 100) / 100; // 2 decimales
        }
        return Math.round(visibilityInKm * 100) / 100; // 2 decimales
    }
    
    function getVisibilityUnit() {
        const isEnglish = window.location.search.includes('lang=en');
        return isEnglish ? 'mi' : 'km';
    }
    
    // Funci√≥n para mostrar notificaci√≥n de √©xito
    function showWeatherSuccess(data) {
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success mt-3';
        successDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>${translations.fieldsAutoFilled}</strong> 
            Latitud, Longitud, Altura (${data.altitude || 0}m), 
            Nubosidad (${Math.round(data.cloudCover)}%)
            <br>
            <small>${translations.otherFieldsManual}</small>
        `;
        
        // Insertar despu√©s del formulario
        const form = document.querySelector('form');
        form.parentNode.insertBefore(successDiv, form.nextSibling);
        
        // Remover despu√©s de 5 segundos
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 5000);
    }
    
    // Funci√≥n para generar datos meteorol√≥gicos realistas
    async function generateRealisticWeatherData(lat, lng) {
        const altitude = await getAltitudeFromCoordinates(lat, lng);
        return {
            cloudCover: generateRealisticCloudCover(),
            altitude: altitude
        };
    }
    
    function generateRealisticCloudCover() {
        return Math.round(Math.random() * 100);
    }
    
    // Funciones para recordar la √∫ltima ubicaci√≥n
    function saveLastLocation(lat, lng) {
        try {
            const location = { lat: lat, lng: lng, timestamp: Date.now() };
            localStorage.setItem('lastWeatherLocation', JSON.stringify(location));
            console.log('üíæ Ubicaci√≥n guardada:', lat, lng);
        } catch (error) {
            console.warn('‚ùå Error guardando ubicaci√≥n:', error);
        }
    }
    
    function getLastLocation() {
        try {
            console.log('üîç Buscando ubicaci√≥n guardada...');
            const saved = localStorage.getItem('lastWeatherLocation');
            console.log('üíæ Datos guardados:', saved);
            
            if (saved) {
                const location = JSON.parse(saved);
                console.log('üìã Ubicaci√≥n parseada:', location);
                
                // Verificar que la ubicaci√≥n no sea muy antigua (7 d√≠as)
                const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as en milisegundos
                const age = Date.now() - location.timestamp;
                console.log('‚è∞ Edad de la ubicaci√≥n:', Math.round(age / (1000 * 60 * 60)), 'horas');
                
                if (age < maxAge) {
                    console.log('‚úÖ Ubicaci√≥n guardada v√°lida:', location.lat, location.lng);
                    return [location.lat, location.lng];
                } else {
                    console.log('‚è∞ Ubicaci√≥n guardada muy antigua, usando por defecto');
                    localStorage.removeItem('lastWeatherLocation');
                }
            } else {
                console.log('‚ùå No hay ubicaci√≥n guardada');
            }
        } catch (error) {
            console.warn('‚ùå Error cargando ubicaci√≥n:', error);
        }
        return null;
    }

    // Funci√≥n para calcular par√°metros de aerosoles
    function calcularAerosoles() {
        console.log('üßÆ Calculando aerosoles...');
        
        // Mostrar indicador de carga
        const boton = document.querySelector('button[onclick="calcularAerosoles()"]');
        const textoOriginal = boton.innerHTML;
        boton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + translations.calculating;
        boton.disabled = true;

        // Simular datos de part√≠culas
        const datosSimulados = generarDatosAerosolesSimulados();
        
        // Calcular par√°metros
        setTimeout(() => {
            // Densidad del polvo
            const densidadPolvo = datosSimulados.masaTotal / datosSimulados.volumenAire;
            const densidadPolvoInput = document.querySelector('input[name="densidad_polvo"]');
            if (densidadPolvoInput) densidadPolvoInput.value = densidadPolvo.toFixed(3);

            // PM2.5 y PM10
            const pm25 = calcularPM(datosSimulados.diametros, datosSimulados.masas, datosSimulados.volumenAire, 2.5);
            const pm10 = calcularPM(datosSimulados.diametros, datosSimulados.masas, datosSimulados.volumenAire, 10.0);
            const pm25Input = document.querySelector('input[name="pm25"]');
            const pm10Input = document.querySelector('input[name="pm10"]');
            if (pm25Input) pm25Input.value = pm25.toFixed(3);
            if (pm10Input) pm10Input.value = pm10.toFixed(3);

            // Distribuci√≥n de tama√±o
            const distribucion = calcularDistribucionTamano(datosSimulados.diametros, datosSimulados.numeros);
            const diametroMedioInput = document.querySelector('input[name="diametro_medio"]');
            const desviacionDiametroInput = document.querySelector('input[name="desviacion_diametro"]');
            if (diametroMedioInput) diametroMedioInput.value = distribucion.medio.toFixed(3);
            if (desviacionDiametroInput) desviacionDiametroInput.value = distribucion.desviacion.toFixed(3);

            // AOD (simulado)
            const aod = datosSimulados.aod;
            const aodInput = document.querySelector('input[name="aod"]');
            if (aodInput) aodInput.value = aod.toFixed(6);

            // Visibilidad
            const visibilidad = 3.912 / datosSimulados.coeficienteExtincion;
            const visibilidadInput = document.querySelector('input[name="visibilidad"]');
            if (visibilidadInput) visibilidadInput.value = (visibilidad / 1000).toFixed(3);

            // Altura de capa de mezcla (simulada)
            const alturaCapaMezcla = datosSimulados.alturaCapaMezcla;
            const alturaCapaMezclaInput = document.querySelector('input[name="altura_capa_mezcla"]');
            if (alturaCapaMezclaInput) alturaCapaMezclaInput.value = alturaCapaMezcla.toFixed(1);

            // Restaurar bot√≥n
            boton.innerHTML = textoOriginal;
            boton.disabled = false;

            // Mostrar notificaci√≥n de √©xito
            mostrarNotificacionAerosoles();
        }, 2000);
    }

    // Funci√≥n para generar datos simulados de aerosoles
    function generarDatosAerosolesSimulados() {
        const nParticulas = 1000;
        const diametros = [];
        const masas = [];
        const numeros = [];

        for (let i = 0; i < nParticulas; i++) {
            const diametro = Math.exp(Math.random() * 0.5 + 1.0);
            diametros.push(diametro);

            const masa = Math.exp(Math.random() * 0.3 + 2.0);
            masas.push(masa);

            const numero = Math.floor(-Math.log(Math.random()) * 5);
            numeros.push(numero);
        }

        return {
            diametros: diametros,
            masas: masas,
            numeros: numeros,
            masaTotal: masas.reduce((sum, masa) => sum + masa, 0),
            volumenAire: 1.0,
            aod: 0.15 + Math.random() * 0.1,
            coeficienteExtincion: 0.0005 + Math.random() * 0.0005,
            alturaCapaMezcla: 800 + Math.random() * 800
        };
    }

    // Funci√≥n para calcular PM
    function calcularPM(diametros, masas, volumenAire, limiteDiametro) {
        let masaTotal = 0;
        for (let i = 0; i < diametros.length; i++) {
            if (diametros[i] <= limiteDiametro) {
                masaTotal += masas[i];
            }
        }
        return masaTotal / volumenAire;
    }

    // Funci√≥n para calcular distribuci√≥n de tama√±o
    function calcularDistribucionTamano(diametros, numeros) {
        const sumaNumeros = numeros.reduce((sum, num) => sum + num, 0);
        if (sumaNumeros === 0) return { medio: 0, desviacion: 0 };

        let sumaPonderada = 0;
        for (let i = 0; i < diametros.length; i++) {
            sumaPonderada += numeros[i] * diametros[i];
        }
        const diametroMedio = sumaPonderada / sumaNumeros;

        let sumaVarianza = 0;
        for (let i = 0; i < diametros.length; i++) {
            sumaVarianza += numeros[i] * Math.pow(diametros[i] - diametroMedio, 2);
        }
        const desviacion = Math.sqrt(sumaVarianza / sumaNumeros);

        return { medio: diametroMedio, desviacion: desviacion };
    }

    // Funci√≥n para mostrar notificaci√≥n de √©xito
    function mostrarNotificacionAerosoles() {
        const notificacion = document.createElement('div');
        notificacion.className = 'alert alert-success alert-dismissible fade show position-fixed';
        notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notificacion.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>¬°Par√°metros de aerosoles calculados!</strong>
            <br>${translations.aerosolCalculated}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notificacion);
        
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 5000);
    }
</script>
{% endblock %}
